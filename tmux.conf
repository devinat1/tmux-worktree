# tmux configuration with git worktree integration
# Reload with: tmux source-file ~/.tmux.conf

# ─────────────────────────────────────────────────────────────
# General Settings
# ─────────────────────────────────────────────────────────────

# Use Ctrl-a as prefix (easier than Ctrl-b)
set -g prefix C-a
set -g prefix2 C-b
bind C-a send-prefix

# Enable mouse support
set -g mouse on

# Start window numbering at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer
set -g history-limit 50000

# Faster command sequences (reduce escape time)
set -s escape-time 10

# Enable focus events
set -g focus-events on

# 256 color support
set -g default-terminal "xterm-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Extended keys support (for fn+arrows, shift+enter, etc.)
# 'always' sends extended keys even if app doesn't request them
# 'csi-u' format is what Claude Code expects
set -g extended-keys on
set -g extended-keys-format csi-u
set -as terminal-features ',*:extkeys'

# ─────────────────────────────────────────────────────────────
# Status Bar
# ─────────────────────────────────────────────────────────────

set -g status-position top
set -g status-style 'bg=#1e1e2e fg=#cdd6f4'

# Left side: session name
set -g status-left-length 30
set -g status-left '#[fg=#89b4fa,bold][#S] '

# Right side: git branch + time
set -g status-right-length 80
set -g status-right '#[fg=#a6e3a1]#{?#{&&:#{pane_current_path},#{!=:#{pane_current_path},}},#(cd #{pane_current_path} && git branch --show-current 2>/dev/null || echo ""),} #[fg=#bac2de]%H:%M'

# Window status
setw -g window-status-format '#[fg=#6c7086] #I:#W '
setw -g window-status-current-format '#[fg=#f38ba8,bold] #I:#W '

# ─────────────────────────────────────────────────────────────
# Key Bindings - Navigation
# ─────────────────────────────────────────────────────────────

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Split panes with | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Override default splits to stay in current directory
bind % split-window -h -c "#{pane_current_path}"
bind '"' split-window -v -c "#{pane_current_path}"

# Navigate panes (h/j/k for vim-style)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U

# Last window (restore default)
unbind l
bind l last-window

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# New window in current directory
bind c new-window -c "#{pane_current_path}"

# ─────────────────────────────────────────────────────────────
# Git Worktree Integration (prefix + g)
# ─────────────────────────────────────────────────────────────

# prefix + g: Enter worktree command mode
bind g switch-client -T worktree_table

# Worktree commands (press prefix + g, then one of these keys):
#   c = create new worktree
#   l = list worktrees
#   s = switch to worktree
#   r = remove worktree
#   x = remove worktree (fuzzy)

bind -T worktree_table c command-prompt -p "New worktree branch:" "display-popup -E -w 80 -h 20 '$HOME/.local/bin/tmux-worktree new %% ; echo Press ENTER to close; read'"
bind -T worktree_table l display-popup -E -w 80 -h 20 "$HOME/.local/bin/tmux-worktree list ; echo ; echo Press ENTER to close; read"
bind -T worktree_table s command-prompt -p "Switch to worktree:" "display-popup -E -w 80 -h 20 '$HOME/.local/bin/tmux-worktree switch %% ; echo Press ENTER to close; read'"
bind -T worktree_table r command-prompt -p "Remove worktree:" "display-popup -E -w 80 -h 20 '$HOME/.local/bin/tmux-worktree remove %% ; echo Press ENTER to close; read'"
bind -T worktree_table x display-popup -E -w 60 -h 15 "$HOME/.local/bin/tmux-worktree pick-remove"

# Quick list with W
bind W display-popup -E -w 80 -h 20 "$HOME/.local/bin/tmux-worktree list ; echo ; echo Press ENTER to close; read"

# Quick worktree picker with w (fuzzy search)
bind w display-popup -E -w 60 -h 15 "$HOME/.local/bin/tmux-worktree pick"

# ─────────────────────────────────────────────────────────────
# Copy Mode (vim-style)
# ─────────────────────────────────────────────────────────────

setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# ─────────────────────────────────────────────────────────────
# Session Management
# ─────────────────────────────────────────────────────────────

# Switch sessions easily
bind ( switch-client -p
bind ) switch-client -n

# Create new session
bind S command-prompt -p "New session name:" "new-session -s '%%'"
